<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Vibe 6W — Pushup/Squat/Plank</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
  <meta name="apple-mobile-web-app-title" content="Vibe6W">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0c10" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f7f8fb" media="(prefers-color-scheme: light)">
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0e1116;
      --fg: #eef2f8;
      --muted: #a9b3c3;
      --card: #131826;
      --surface: #101726;
      --sep: #222b3a;
      --accent: #8fb2ff;
      /* pastel blue */
      --tile1: #1c2744;
      /* pastel tint dark */
      --tile2: #1a2f26;
      /* pastel mint tint dark */
      --tile3: #3a2e19;
      /* pastel amber tint dark */
      --header: rgba(255, 255, 255, 0.06)
    }

    @media(prefers-color-scheme:light) {
      :root {
        --bg: #f7f9ff;
        --fg: #0c1220;
        --muted: #6b7280;
        --card: #ffffff;
        --surface: #f2f6ff;
        /* pastel blue surface */
        --sep: #e6e9f2;
        --accent: #7aa7ff;
        /* pastel blue */
        --tile1: #eaf2ff;
        /* blue */
        --tile2: #eafaf2;
        /* mint */
        --tile3: #fff5e1;
        /* amber */
        --header: rgba(122, 167, 255, 0.18)
      }
    }

    /* Sidebar contrast tuning for light mode */
    @media(prefers-color-scheme:light) {
      #sidebar {
        background: rgba(255, 255, 255, 0.72) !important;
        border-right: 1px solid var(--sep);
        backdrop-filter: blur(8px);
      }

      #sidebar a {
        color: var(--fg);
      }

      #sidebar h2 {
        color: var(--fg);
      }

      header {
        background: rgba(255, 255, 255, .7);
      }
    }

    /* Enforce background on whole viewport when iOS hides toolbar */
    #appRoot,
    main,
    section {
      background: var(--bg);
    }

    html,
    body {
      background: var(--bg);
    }

    body {
      min-height: 100svh;
      overscroll-behavior-y: contain;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg)
    }

    .hidden {
      display: none !important
    }

    header {
      position: sticky;
      top: 0;
      padding: calc(14px + env(safe-area-inset-top)) 16px 14px;
      background: var(--header);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--sep);
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 64px
    }

    .h1 {
      margin: 0;
      font-weight: 800;
      font-size: 20px
    }

    main {
      max-width: 760px;
      margin: 0 auto;
      padding: 16px;
      overscroll-behavior-y: contain
    }

    .grid {
      display: grid;
      gap: 12px
    }

    .card {
      background: var(--card);
      border: 1px solid var(--sep);
      border-radius: 18px;
      padding: 14px
    }

    .workout {
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 64px;
      border-radius: 18px;
      cursor: pointer
    }

    .workout .name {
      font-weight: 700
    }

    .workout .sub {
      font-size: 12px;
      color: var(--muted);
      margin-left: auto
    }

    .workout[data-go=pushup] {
      background: var(--tile1)
    }

    .workout[data-go=squat] {
      background: var(--tile2)
    }

    .workout[data-go=plank] {
      background: var(--tile3)
    }

    .workout::after {
      content: '›';
      opacity: .6
    }

    .setrow {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      align-items: center;
      background: var(--surface);
      border: 1px solid var(--sep);
      border-radius: 14px;
      padding: 10px;
      margin-top: 6px
    }

    .setnum {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      border: 1px solid var(--sep);
      background: var(--card);
      font-weight: 700
    }

    .timer {
      display: grid;
      gap: 6px;
      place-items: center;
      border: 1px solid var(--sep);
      border-radius: 14px;
      padding: 12px;
      background: var(--surface)
    }

    #rest {
      font-weight: 800;
      font-size: 32px
    }

    .small {
      font-size: 12px;
      color: var(--muted)
    }

    .btn {
      appearance: none;
      border: 1px solid var(--sep);
      background: var(--card);
      color: var(--fg);
      border-radius: 12px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer
    }

    .btn.flat {
      border-color: var(--accent);
      color: var(--accent);
      background: transparent
    }

    .btn.ghost {
      background: transparent;
      border-color: var(--sep)
    }

    .page-label {
      margin-top: 16px;
      text-align: center;
      font-size: 11px;
      color: var(--muted)
    }

    /* Calendar */
    .cal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px
    }

    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px
    }

    .cal-cell {
      height: 38px;
      display: grid;
      place-items: center;
      border: 1px solid var(--sep);
      border-radius: 10px;
      background: var(--card);
      position: relative;
      color: var(--muted)
    }

    .cal-cell .dot {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #ff4d4f
    }

    .cal-cell.today {
      color: var(--fg);
      background: linear-gradient(180deg, rgba(122, 167, 255, 0.25), rgba(122, 167, 255, 0.15));
      border-color: rgba(122, 167, 255, 0.45);
      font-weight: 800
    }

    .cal-cell.selected {
      color: var(--fg);
      background: linear-gradient(180deg, rgba(98, 240, 196, 0.25), rgba(98, 240, 196, 0.12));
      border-color: rgba(98, 240, 196, 0.45);
      font-weight: 800
    }

    .cal-dow {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      margin-bottom: 6px
    }

    .streak {
      font-weight: 700
    }

    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 240px;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
      padding: calc(16px + env(safe-area-inset-top)) 20px 20px;
      box-sizing: border-box;
      transform: translateX(-100%);
      transition: transform .25s ease;
      z-index: 100
    }

    #sidebar.show {
      transform: translateX(0)
    }

    #sidebar h2 {
      margin: 0 0 12px;
      color: var(--fg)
    }

    #sidebar ul {
      list-style: none;
      padding: 0;
      margin: 20px 0
    }

    #sidebar li {
      margin: 10px 0
    }

    #sidebar a {
      color: var(--fg);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer
    }

    .scrim {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .28);
      backdrop-filter: blur(2px);
      z-index: 90
    }

    .scrim.hidden {
      display: none
    }

    .modal {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0, 0, 0, .35);
      backdrop-filter: blur(2px);
      z-index: 120
    }

    .modal.hidden {
      display: none
    }

    .dialog {
      width: min(92vw, 440px);
      background: var(--card);
      border: 1px solid var(--sep);
      border-radius: 16px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .35);
      padding: 16px
    }

    .dialog .title {
      font-weight: 700;
      margin-bottom: 8px
    }

    .dialog .row {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 10px
    }
  </style>
</head>

<body>
  <header>
    <button id="menuBtn" class="btn ghost">☰</button>
    <h1 class="h1" id="title">Workout Selection</h1>
    <button id="backTop" class="btn ghost hidden">←</button>
  </header>

  <div id="sidebar">
    <h2>Menu</h2>
    <ul>
      <li><a href="#" data-nav="home">Home</a></li>
      <li><a href="#" data-nav="calendar">Calendar</a></li>
      <li><a href="#" data-nav="pushup">Push-ups</a></li>
      <li><a href="#" data-nav="squat">Squats</a></li>
      <li><a href="#" data-nav="plank">Plank</a></li>
      <li><a href="#" data-nav="reset">Reset</a></li>
    </ul>
  </div>
  <div id="scrim" class="scrim hidden" aria-hidden="true"></div>

  <main>
    <section id="home">
      <div class="grid">
        <div class="card workout" data-go="pushup">
          <div class="name">Push-ups</div>
          <div class="sub" id="home-prog-pushup">Sets · Reps</div>
        </div>
        <div class="card workout" data-go="squat">
          <div class="name">Squats</div>
          <div class="sub" id="home-prog-squat">Sets · Reps</div>
        </div>
        <div class="card workout" data-go="plank">
          <div class="name">Plank</div>
          <div class="sub" id="home-prog-plank">Seconds · Timer</div>
        </div>
      </div>
      <div class="page-label">Home</div>
    </section>

    <section id="calendar" class="hidden">
      <div class="card">
        <div class="cal-header">
          <button class="btn ghost" id="cal-prev">‹</button>
          <div><b id="cal-ym">2024-01</b> · <span class="streak" id="cal-streak">0</span> day streak</div>
          <button class="btn ghost" id="cal-next">›</button>
        </div>
        <div class="cal-dow">Sun · Mon · Tue · Wed · Thu · Fri · Sat</div>
        <div class="cal-grid" id="cal-grid"></div>
      </div>
      <div class="card" id="cal-detail" style="margin-top:10px">
        <div class="small" style="margin-bottom:6px">Selected Day</div>
        <div id="cal-detail-text">—</div>
      </div>
      <div class="page-label">Calendar</div>
    </section>

    <section id="session" class="hidden">
      <div class="card">
        <div class="small" id="wname"></div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
          <span class="small" id="progText">Week 1 · Day 1</span>
          <div style="display:flex;gap:6px">
            <button class="btn ghost" id="prev" title="Previous">‹ Prev</button>
            <button class="btn flat" id="next" title="Finish">Finish Session</button>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="small" style="margin-bottom:6px">Today's Sets</div>
        <div id="sets"></div>
      </div>
      <div class="card">
        <div class="small" style="margin-bottom:6px">Rest Timer</div>
        <div class="timer">
          <div id="rest">01:30</div>
          <button id="toggle" class="btn">Start</button>
        </div>
      </div>
      <div class="page-label">Session</div>
    </section>

    <section id="reset" class="hidden">
      <div class="card">
        <div class="small" style="margin-bottom:8px">Reset Progress</div>
        <div class="grid" style="grid-template-columns:1fr;gap:10px">
          <div class="card" style="padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><b>Push-ups</b> <span class="small" id="rp-pushup"></span></div>
              <button class="btn" id="rst-pushup">Clear</button>
            </div>
          </div>
          <div class="card" style="padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><b>Squats</b> <span class="small" id="rp-squat"></span></div>
              <button class="btn" id="rst-squat">Clear</button>
            </div>
          </div>
          <div class="card" style="padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><b>Plank</b> <span class="small" id="rp-plank"></span></div>
              <button class="btn" id="rst-plank">Clear</button>
            </div>
          </div>
          <div class="card" style="padding:12px;border: 2px dashed var(--sep)">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><b>Calendar Records</b> <span class="small">Clear all records</span></div>
              <button class="btn flat" id="rst-calendar">Clear</button>
            </div>
          </div>
        </div>
      </div>
      <div class="page-label">Reset</div>
    </section>
  </main>

  <div id="maxModal" class="modal hidden">
    <div class="dialog">
      <div class="title" id="maxPrompt">Enter your maximum</div>
      <input id="maxInput" type="number" min="1" placeholder="Enter a number"
        style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--sep);background:var(--surface);color:var(--fg)">
      <div class="row">
        <button class="btn ghost" id="maxCancel">Cancel</button>
        <button class="btn flat" id="maxSave">Save</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Core state/util =====
    const $ = q => document.querySelector(q), $$ = q => Array.from(document.querySelectorAll(q));
    const id = q => document.getElementById(q);
    const SKEY = 'vibe6w_final_v5';
    const D = () => ({ rest: 90, workout: 'pushup', sets: [], max: {}, progress: { pushup: { w: 1, d: 1 }, squat: { w: 1, d: 1 }, plank: { w: 1, d: 1 } }, done: {} });
    let st = JSON.parse(localStorage.getItem(SKEY) || 'null') || D();
    const save = () => localStorage.setItem(SKEY, JSON.stringify(st));
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const pad2 = n => String(n).padStart(2, '0');
    const fmt = s => { s = Math.max(0, s | 0); return pad2((s / 60 | 0)) + ':' + pad2(s % 60 | 0) };

    // ===== Strings & helpers =====
    const STR = {
      confirmClearAll: 'Delete all calendar completion records?',
      alertCalCleared: 'Calendar records have been cleared.',
      alertWorkoutCleared: (name) => `${name} cleared. Initial max will be requested next time.`
    };
    const ymdFrom = (y, m, d) => `${y}-${pad2(m)}-${pad2(d)}`;
    const getTodayKey = () => { const t = new Date(); return ymdFrom(t.getFullYear(), t.getMonth() + 1, t.getDate()); };

    // ===== Constants & helpers (cleaned) =====
    const WORKOUT_LABEL = { pushup: 'Push-ups', squat: 'Squats', plank: 'Plank' };
    const MAX_PROMPT = {
      pushup: 'Enter max push-ups',
      squat: 'Enter max squats',
      plank: 'Enter max plank hold (sec)'
    };
    const DEFAULT_MAX = { pushup: 20, squat: 30, plank: 45 };

    // ===== Navigation/views =====
    // Wake Lock handle
    let wakeLock = null;
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener && wakeLock.addEventListener('release', () => { });
        }
      } catch (_) { }
    }
    async function releaseWakeLock() {
      try { if (wakeLock) { await wakeLock.release(); wakeLock = null; } } catch (_) { }
    }
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && !id('session').classList.contains('hidden')) {
        requestWakeLock();
      }
    });

    function view(v) {
      id('home').classList.toggle('hidden', v !== 'home');
      id('calendar').classList.toggle('hidden', v !== 'calendar');
      id('session').classList.toggle('hidden', v !== 'session');
      id('reset').classList.toggle('hidden', v !== 'reset');
      const titleMap = { home: 'Workout Selection', calendar: 'Calendar', session: (st.workoutName || 'Session'), reset: 'Reset' };
      id('title').textContent = titleMap[v] || 'Vibe 6W';
      id('backTop').classList.toggle('hidden', v === 'home');
      if (v === 'session') { requestWakeLock(); } else { releaseWakeLock(); }
      if (v === 'calendar') { renderCalendar(); }
    }
    $('#backTop').addEventListener('click', () => view('home'));

    // ===== Progress helpers =====
    function getProg(ex) { st.progress[ex] = st.progress[ex] || { w: 1, d: 1 }; return st.progress[ex]; }
    function incProg(ex) { const p = getProg(ex); p.d++; if (p.d > 3) { p.d = 1; p.w = clamp(p.w + 1, 1, 6); } save(); }

    // ===== Plans (from your text) =====
    const REST_BY_WEEK_DAY = { 1: [60, 60, 60], 2: [60, 90, 120], 3: [90, 90, 120], 4: [60, 90, 120], 5: [60, 45, 45], 6: [60, 45, 45] };
    const PUSHUP_PLAN = {
      1: {
        1: [{ min: 0, max: 4, sets: [2, 3, 2, 2, 3] }, { min: 5, max: 10, sets: [6, 6, 4, 4, 5] }, { min: 11, max: 20, sets: [10, 12, 7, 7, 9] }],
        2: [{ min: 0, max: 4, sets: [3, 4, 2, 3, 4] }, { min: 5, max: 10, sets: [6, 8, 6, 6, 7] }, { min: 11, max: 20, sets: [10, 12, 8, 8, 12] }],
        3: [{ min: 0, max: 4, sets: [4, 5, 4, 4, 5] }, { min: 5, max: 10, sets: [8, 10, 7, 7, 10] }, { min: 11, max: 20, sets: [11, 15, 9, 9, 13] }]
      },
      2: {
        1: [{ min: 0, max: 5, sets: [4, 6, 4, 4, 6] }, { min: 6, max: 10, sets: [9, 11, 8, 8, 11] }, { min: 11, max: 20, sets: [14, 14, 10, 10, 15] }],
        2: [{ min: 0, max: 5, sets: [5, 6, 4, 4, 7] }, { min: 6, max: 10, sets: [10, 12, 9, 9, 13] }, { min: 11, max: 20, sets: [14, 16, 12, 12, 17] }],
        3: [{ min: 0, max: 5, sets: [5, 7, 5, 5, 8] }, { min: 6, max: 10, sets: [12, 13, 10, 10, 15] }, { min: 11, max: 20, sets: [16, 17, 14, 14, 20] }]
      },
      3: {
        1: [{ min: 0, max: 5, sets: [10, 12, 7, 7, 9] }, { min: 6, max: 10, sets: [12, 17, 13, 13, 17] }, { min: 11, max: 20, sets: [14, 18, 14, 14, 20] }],
        2: [{ min: 0, max: 5, sets: [10, 12, 8, 8, 12] }, { min: 6, max: 10, sets: [14, 19, 14, 14, 19] }, { min: 11, max: 20, sets: [20, 25, 15, 15, 25] }],
        3: [{ min: 0, max: 5, sets: [11, 13, 9, 9, 13] }, { min: 6, max: 10, sets: [16, 21, 15, 15, 21] }, { min: 11, max: 20, sets: [22, 30, 20, 20, 28] }]
      },
      4: {
        1: [{ min: 0, max: 5, sets: [12, 14, 11, 10, 16] }, { min: 6, max: 10, sets: [18, 22, 16, 16, 25] }, { min: 11, max: 20, sets: [21, 25, 21, 21, 32] }],
        2: [{ min: 0, max: 5, sets: [14, 16, 12, 12, 18] }, { min: 6, max: 10, sets: [20, 25, 20, 20, 28] }, { min: 11, max: 20, sets: [25, 29, 25, 25, 36] }],
        3: [{ min: 0, max: 5, sets: [16, 18, 13, 13, 20] }, { min: 6, max: 10, sets: [23, 28, 23, 23, 33] }, { min: 11, max: 20, sets: [29, 33, 29, 29, 40] }]
      },
      5: {
        1: [{ min: 0, max: 5, sets: [17, 19, 15, 15, 20] }, { min: 6, max: 10, sets: [28, 35, 25, 22, 35] }, { min: 11, max: 20, sets: [36, 40, 30, 24, 40] }],
        2: [{ min: 0, max: 5, sets: [10, 10, 13, 13, 10, 10, 9, 25] }, { min: 6, max: 10, sets: [18, 18, 20, 20, 14, 14, 16, 40] }, { min: 11, max: 20, sets: [19, 19, 22, 22, 18, 18, 22, 45] }],
        3: [{ min: 0, max: 5, sets: [13, 13, 15, 15, 12, 12, 10, 30] }, { min: 6, max: 10, sets: [18, 18, 20, 20, 17, 17, 20, 45] }, { min: 11, max: 20, sets: [20, 20, 24, 24, 20, 20, 22, 50] }]
      },
      6: {
        1: [{ min: 0, max: 5, sets: [25, 30, 20, 15, 40] }, { min: 6, max: 10, sets: [40, 50, 25, 25, 50] }, { min: 11, max: 20, sets: [45, 55, 35, 30, 55] }],
        2: [{ min: 0, max: 5, sets: [14, 14, 15, 15, 14, 14, 10, 10, 44] }, { min: 6, max: 10, sets: [20, 20, 23, 23, 20, 20, 18, 18, 53] }, { min: 11, max: 20, sets: [22, 22, 30, 30, 24, 24, 18, 18, 58] }],
        3: [{ min: 0, max: 5, sets: [13, 13, 17, 17, 16, 16, 14, 14, 50] }, { min: 6, max: 10, sets: [22, 22, 30, 30, 25, 25, 18, 18, 55] }, { min: 11, max: 20, sets: [26, 26, 33, 33, 26, 26, 22, 22, 60] }]
      }
    };

    // Squat: exact plan from your text (bucketed by tested max squats)
    // Buckets: <15 => [0,14], 16-35 => [16,35], >36 => [36,Infinity]
    const SQUAT_REST_BY_WEEK_DAY = { 1: [60, 60, 60], 2: [60, 60, 60], 3: [90, 90, 90], 4: [90, 90, 90], 5: [120, 120, 120], 6: [120, 120, 120] };
    const SQUAT_PLAN = {
      1: {
        1: [{ min: 0, max: 14, sets: [5, 6, 5, 4, 7] }, { min: 16, max: 35, sets: [13, 16, 13, 11, 18] }, { min: 36, max: 9999, sets: [18, 24, 18, 16, 26] }],
        2: [{ min: 0, max: 14, sets: [6, 7, 6, 5, 8] }, { min: 16, max: 35, sets: [13, 17, 13, 12, 19] }, { min: 36, max: 9999, sets: [19, 24, 19, 17, 27] }],
        3: [{ min: 0, max: 14, sets: [7, 8, 7, 6, 9] }, { min: 16, max: 35, sets: [15, 19, 15, 13, 20] }, { min: 36, max: 9999, sets: [20, 26, 20, 18, 28] }]
      },
      2: {
        1: [{ min: 0, max: 14, sets: [8, 10, 8, 7, 11] }, { min: 16, max: 35, sets: [16, 20, 16, 14, 22] }, { min: 36, max: 9999, sets: [21, 27, 21, 19, 30] }],
        2: [{ min: 0, max: 14, sets: [10, 12, 10, 8, 13] }, { min: 16, max: 35, sets: [18, 22, 18, 16, 24] }, { min: 36, max: 9999, sets: [23, 30, 23, 21, 33] }],
        3: [{ min: 0, max: 14, sets: [12, 15, 12, 10, 16] }, { min: 16, max: 35, sets: [20, 25, 20, 18, 28] }, { min: 36, max: 9999, sets: [26, 33, 26, 23, 36] }]
      },
      3: {
        1: [{ min: 0, max: 14, sets: [14, 18, 14, 12, 19] }, { min: 16, max: 35, sets: [22, 28, 22, 19, 30] }, { min: 36, max: 9999, sets: [28, 36, 28, 25, 39] }],
        2: [{ min: 0, max: 14, sets: [17, 21, 17, 15, 23] }, { min: 16, max: 35, sets: [25, 32, 25, 22, 35] }, { min: 36, max: 9999, sets: [31, 40, 31, 28, 43] }],
        3: [{ min: 0, max: 14, sets: [20, 26, 20, 18, 28] }, { min: 16, max: 35, sets: [28, 36, 28, 25, 39] }, { min: 36, max: 9999, sets: [35, 45, 35, 31, 48] }]
      },
      4: {
        1: [{ min: 0, max: 14, sets: [23, 29, 23, 20, 32] }, { min: 16, max: 35, sets: [31, 40, 31, 28, 43] }, { min: 36, max: 9999, sets: [38, 48, 38, 34, 53] }],
        2: [{ min: 0, max: 14, sets: [27, 35, 27, 24, 38] }, { min: 16, max: 35, sets: [36, 45, 36, 32, 49] }, { min: 36, max: 9999, sets: [42, 54, 42, 38, 59] }],
        3: [{ min: 0, max: 14, sets: [32, 41, 32, 28, 44] }, { min: 16, max: 35, sets: [40, 51, 40, 36, 56] }, { min: 36, max: 9999, sets: [47, 61, 47, 42, 66] }]
      },
      5: {
        1: [{ min: 0, max: 14, sets: [36, 45, 36, 32, 49] }, { min: 16, max: 35, sets: [44, 56, 44, 39, 61] }, { min: 36, max: 9999, sets: [51, 66, 51, 46, 71] }],
        2: [{ min: 0, max: 14, sets: [41, 52, 41, 36, 57] }, { min: 16, max: 35, sets: [49, 63, 49, 44, 69] }, { min: 36, max: 9999, sets: [57, 73, 57, 51, 79] }],
        3: [{ min: 0, max: 14, sets: [47, 60, 47, 41, 65] }, { min: 16, max: 35, sets: [55, 71, 55, 49, 77] }, { min: 36, max: 9999, sets: [63, 81, 63, 56, 88] }]
      },
      6: {
        1: [{ min: 0, max: 14, sets: [51, 66, 51, 46, 71] }, { min: 16, max: 35, sets: [60, 77, 60, 53, 83] }, { min: 36, max: 9999, sets: [68, 87, 68, 61, 95] }],
        2: [{ min: 0, max: 14, sets: [58, 74, 58, 51, 80] }, { min: 16, max: 35, sets: [67, 85, 67, 59, 93] }, { min: 36, max: 9999, sets: [75, 96, 75, 67, 105] }],
        3: [{ min: 0, max: 14, sets: [65, 84, 65, 58, 90] }, { min: 16, max: 35, sets: [74, 94, 74, 66, 102] }, { min: 36, max: 9999, sets: [83, 106, 83, 74, 115] }]
      }
    };

    // ===== Routine generation =====
    const matchBucket = (bs, max) => bs.find(b => max >= b.min && max <= b.max);
    const pushupFromPlan = (w, d, max) => { const wk = PUSHUP_PLAN[w]; if (!wk) return null; const bs = wk[d]; if (!bs) return null; const b = matchBucket(bs, max) || bs[bs.length - 1]; return b ? b.sets.slice() : null; };
    const squatFromPlan = (w, d, max) => { const wk = SQUAT_PLAN[w]; if (!wk) return null; const bs = wk[d]; if (!bs) return null; const b = matchBucket(bs, max) || bs[bs.length - 1]; return b ? b.sets.slice() : null; };
    function fiveSetsFrom(maxVal, week, day, type) {
      const base = type === 'plank' ? 0.5 : 0.55;
      const rate = base + 0.04 * (week - 1) + 0.02 * (day - 1);
      const first = Math.max(type === 'plank' ? 10 : 1, Math.round(maxVal * rate));
      const step = type === 'plank' ? 5 : Math.max(1, Math.round(maxVal * 0.05));
      const a = [first, first + step, first + 2 * step, first + step, first];
      return a.map(v => type === 'plank' ? Math.min(Math.round(maxVal * 1.2), v) : Math.min(Math.round(maxVal * 0.9), v));
    }
    function genRoutine(ex) {
      const p = getProg(ex);
      if (ex === 'pushup') {
        const exact = pushupFromPlan(p.w, p.d, st.max.pushup || 0); if (exact) return exact;
      } else if (ex === 'squat') {
        const exact = squatFromPlan(p.w, p.d, st.max.squat || 0); if (exact) return exact;
      }
      const max = st.max[ex] || (ex === 'plank' ? 30 : 10);
      return fiveSetsFrom(max, p.w, p.d, ex === 'plank' ? 'plank' : 'reps');
    }

    // ===== Max modal =====
    let pendingEx = null;
    function openMaxModal(ex) {
      pendingEx = ex;
      $('#maxPrompt').textContent = MAX_PROMPT[ex] || 'Enter your maximum';
      $('#maxInput').value = DEFAULT_MAX[ex] ?? 10;
      $('#maxModal').classList.remove('hidden');
      setTimeout(() => $('#maxInput').focus(), 0);
    }
    function closeMaxModal() { $('#maxModal').classList.add('hidden'); pendingEx = null; }
    function saveMax() {
      const ex = pendingEx;
      const v = Number($('#maxInput').value);
      if (!Number.isFinite(v) || v <= 0) { alert('Please enter a valid number.'); return; }
      st.max[ex] = Math.round(v);
      st.progress[ex] = { w: 1, d: 1 };
      st.workout = ex;
      save();
      setupSession(ex);
      closeMaxModal();
      view('session');
    }
    $('#maxSave').addEventListener('click', saveMax);
    $('#maxCancel').addEventListener('click', closeMaxModal);
    $('#maxInput').addEventListener('keydown', e => { if (e.key === 'Enter') saveMax(); if (e.key === 'Escape') closeMaxModal(); });

    // ===== Render/session =====
    function setDefaults() {
      const w = st.workout;
      st.workoutName = WORKOUT_LABEL[w] || 'Session';
      $('#wname').textContent = st.workoutName;
      const p = getProg(w);
      $('#progText').textContent = `Week ${p.w} · Day ${p.d}`;
    }
    function refreshHomeProgress() {
      const pp = getProg('pushup');
      const sp = getProg('squat');
      const lp = getProg('plank');
      const hp = document.getElementById('home-prog-pushup'); if (hp) hp.textContent = `Week ${pp.w} · Day ${pp.d}`;
      const hs = document.getElementById('home-prog-squat'); if (hs) hs.textContent = `Week ${sp.w} · Day ${sp.d}`;
      const hl = document.getElementById('home-prog-plank'); if (hl) hl.textContent = `Week ${lp.w} · Day ${lp.d}`;
    }
    function renderSets() { const box = $('#sets'); box.innerHTML = ''; st.sets.forEach((v, i) => { const r = document.createElement('div'); r.className = 'setrow'; r.innerHTML = `<div class="setnum">${i + 1}</div><div>${st.workout === 'plank' ? `<b>${v}s</b> Plank <span class="small">Left:<b id="rem-${i}">${fmt(v)}</b></span>` : `<b>${v} reps</b> ${st.workoutName}`}</div><div><input type="checkbox"></div>`; box.appendChild(r); }); }
    function restMapFor(ex, week) {
      return ex === 'squat' ? (SQUAT_REST_BY_WEEK_DAY[week] || [90, 90, 90]) : (REST_BY_WEEK_DAY[week] || [90, 90, 90]);
    }

    function setupSession(forceEx) {
      if (forceEx) st.workout = forceEx;
      setDefaults();
      const p = getProg(st.workout);
      const restMap = restMapFor(st.workout, p.w);
      st.rest = restMap[p.d - 1] || 90;
      st.sets = genRoutine(st.workout);
      renderSets();
      id('rest').textContent = fmt(st.rest);
    }

    function startWorkout(ex) {
      if (!['pushup', 'squat', 'plank'].includes(ex)) return;
      if (st.max[ex] == null) { openMaxModal(ex); return; }
      setupSession(ex);
      view('session');
    }
    $$('.workout').forEach(c => c.addEventListener('click', () => startWorkout(c.dataset.go)));

    function markTodayDone() {
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const d = String(today.getDate()).padStart(2, '0');
      const key = `${y}-${m}-${d}`;
      const p = getProg(st.workout);
      const entry = { workout: st.workout, week: p.w, day: p.d };
      const cur = st.done[key];
      if (Array.isArray(cur)) {
        if (!cur.some(e => e.workout === entry.workout && e.week === entry.week && e.day === entry.day)) cur.push(entry);
      } else if (cur && typeof cur === 'object') {
        const arr = [cur];
        if (!arr.some(e => e.workout === entry.workout && e.week === entry.week && e.day === entry.day)) arr.push(entry);
        st.done[key] = arr;
      } else {
        st.done[key] = [entry];
      }
    }
    function advanceSession() { incProg(st.workout); markTodayDone(); setupSession(); save(); refreshHomeProgress(); }
    function prevSession() { const p = getProg(st.workout); p.d--; if (p.d < 1) { if (p.w > 1) { p.w--; p.d = 3; } else { p.d = 1; } } save(); setupSession(); }
    $('#next').addEventListener('click', advanceSession);
    $('#prev').addEventListener('click', prevSession);

    // ===== Timer =====
    let restTimer = null, running = false, remain = 0;
    function syncRest() { $('#rest').textContent = fmt(remain); }
    function startRest() { if (running) return; remain = st.rest | 0; syncRest(); running = true; restTimer = setInterval(() => { remain = Math.max(0, remain - 1); syncRest(); if (remain <= 0) { stopRest(); } }, 1000); $('#toggle').textContent = 'Stop'; }
    function stopRest() { if (!running) return; running = false; clearInterval(restTimer); $('#toggle').textContent = 'Start'; }
    $('#toggle').addEventListener('click', () => running ? stopRest() : startRest());

    // ===== Sidebar & gestures =====
    const sidebarEl = id('sidebar'), scrimEl = id('scrim');
    const isOpen = () => sidebarEl.classList.contains('show');
    const openSidebar = () => { sidebarEl.classList.add('show'); scrimEl.classList.remove('hidden'); };
    const closeSidebar = () => { sidebarEl.classList.remove('show'); scrimEl.classList.add('hidden'); };
    $('#menuBtn').addEventListener('click', () => isOpen() ? closeSidebar() : openSidebar());
    scrimEl.addEventListener('click', closeSidebar);
    $$('#sidebar a').forEach(a => a.addEventListener('click', e => {
      e.preventDefault();
      const nav = a.dataset.nav;
      if (nav === 'home') { view('home'); }
      else if (nav === 'calendar') { view('calendar'); defaultCalendarDetail(); }
      else if (['pushup', 'squat', 'plank'].includes(nav)) { startWorkout(nav); }
      else if (nav === 'reset') { refreshReset(); view('reset'); }
      closeSidebar();
    }));
    let tsX = 0, tsY = 0, swiping = false, edgeOpen = false;
    window.addEventListener('touchstart', e => { const t = e.touches[0]; tsX = t.clientX; tsY = t.clientY; swiping = false; edgeOpen = !isOpen() && tsX < 24; if (isOpen() || edgeOpen) swiping = true; }, { passive: true });
    window.addEventListener('touchmove', e => { if (!swiping) return; const t = e.touches[0]; const dx = t.clientX - tsX; const dy = Math.abs(t.clientY - tsY); if (dy > 28) { swiping = false; return; } if (edgeOpen && dx > 40) { openSidebar(); swiping = false; } if (isOpen() && dx < -40) { closeSidebar(); swiping = false; } }, { passive: true });
    window.addEventListener('touchend', () => { swiping = false; edgeOpen = false; }, { passive: true });

    // ===== Reset page =====
    function refreshReset() {
      const pp = getProg('pushup'), sp = getProg('squat'), lp = getProg('plank');
      const rpP = id('rp-pushup');
      const rpS = id('rp-squat');
      const rpL = id('rp-plank');
      if (rpP) rpP.textContent = `· Week ${pp.w} · Day ${pp.d}` + (st.max.pushup == null ? ' · Max: not set' : '');
      if (rpS) rpS.textContent = `· Week ${sp.w} · Day ${sp.d}` + (st.max.squat == null ? ' · Max: not set' : '');
      if (rpL) rpL.textContent = `· Week ${lp.w} · Day ${lp.d}` + (st.max.plank == null ? ' · Max: not set' : '');
    }
    ['pushup', 'squat', 'plank'].forEach(ex => {
      const btn = id('rst-' + ex);
      if (btn) btn.addEventListener('click', () => {
        st.progress[ex] = { w: 1, d: 1 };
        st.max[ex] = null; // force re-input of initial max next time
        save();
        refreshReset();
        refreshHomeProgress();
        alert(STR.alertWorkoutCleared(ex.charAt(0).toUpperCase() + ex.slice(1)));
      });
    });
    const rc = id('rst-calendar');
    if (rc) rc.addEventListener('click', () => {
      if (confirm(STR.confirmClearAll)) {
        st.done = {};
        save();
        if (!id('calendar').classList.contains('hidden')) { renderCalendar(); defaultCalendarDetail(); }
        alert(STR.alertCalCleared);
      }
    });

    // ===== Init =====
    // ===== Calendar =====
    let calYear = (new Date()).getFullYear();
    let calMonth = (new Date()).getMonth();
    let calSelectedKey = null;
    function ymd(dt) {
      const y = dt.getFullYear();
      const m = String(dt.getMonth() + 1).padStart(2, '0');
      const d = String(dt.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }
    function hasRecord(val) { return Array.isArray(val) ? val.length > 0 : (val && typeof val === 'object'); }
    function calcStreak() {
      let streak = 0;
      const today = new Date();
      let cur = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      while (st.done && hasRecord(st.done[ymd(cur)])) { streak++; cur.setDate(cur.getDate() - 1); }
      return streak;
    }
    function selectCalendarKey(key) {
      const grid = id('cal-grid');
      if (!grid || !key) return;
      const [y, m, d] = key.split('-').map(v => Number(v));
      // clear previous selection
      $$('#cal-grid .cal-cell').forEach(el => el.classList.remove('selected'));
      if (y === calYear && (m - 1) === calMonth) {
        const offset = (new Date(calYear, calMonth, 1)).getDay();
        const idx = offset + (d - 1);
        const cells = $$('#cal-grid .cal-cell');
        if (cells[idx]) cells[idx].classList.add('selected');
      }
      calSelectedKey = key;
      showDayDetail(key);
    }
    function renderCalendar() {
      const grid = id('cal-grid');
      if (!grid) return;
      const first = new Date(calYear, calMonth, 1);
      const last = new Date(calYear, calMonth + 1, 0);
      const startDow = first.getDay();
      const days = last.getDate();
      grid.innerHTML = '';
      id('cal-ym').textContent = `${calYear}-${String(calMonth + 1).padStart(2, '0')}`;
      const streakEl = id('cal-streak'); if (streakEl) streakEl.textContent = String(calcStreak());
      for (let i = 0; i < startDow; i++) {
        const pad = document.createElement('div');
        pad.className = 'cal-cell';
        pad.style.visibility = 'hidden';
        grid.appendChild(pad);
      }
      const now = new Date();
      const isThisMonth = (now.getFullYear() === calYear) && (now.getMonth() === calMonth);
      for (let d = 1; d <= days; d++) {
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        cell.textContent = d;
        if (isThisMonth && d === now.getDate()) {
          cell.classList.add('today');
        }
        const key = `${calYear}-${String(calMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        if (st.done && hasRecord(st.done[key])) {
          const dot = document.createElement('div');
          dot.className = 'dot';
          cell.appendChild(dot);
          // keep text readable, no overlap as dot is top-right
        }
        cell.addEventListener('click', () => selectCalendarKey(key));
        grid.appendChild(cell);
      }
      // keep previous selection if still in view
      if (calSelectedKey) selectCalendarKey(calSelectedKey);
    }
    function showDayDetail(key) {
      const box = id('cal-detail-text');
      if (!box) return;
      const info = st.done && st.done[key];
      if (!info) { box.textContent = ''; return; }
      let entries = [];
      if (Array.isArray(info)) {
        entries = info.filter(e => e && typeof e === 'object' && e.workout && e.week && e.day);
      } else if (info && typeof info === 'object') {
        entries = (info.workout && info.week && info.day) ? [info] : [];
      }
      if (entries.length === 0) { box.textContent = ''; return; }
      const lines = entries.map(e => {
        const label = WORKOUT_LABEL[e.workout] || e.workout;
        return `${label} · Week ${e.week} · Day ${e.day}`;
      });
      box.innerHTML = `${key}<br>` + lines.join('<br>');
    }
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'cal-prev') { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } renderCalendar(); defaultCalendarDetail(); }
      if (e.target && e.target.id === 'cal-next') { calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } renderCalendar(); defaultCalendarDetail(); }
    });
    function defaultCalendarDetail() {
      const today = new Date();
      const key = getTodayKey();
      const inView = (today.getFullYear() === calYear) && (today.getMonth() === calMonth);
      if (inView) {
        selectCalendarKey(key);
      }
      else {
        const box = id('cal-detail-text');
        if (box) box.textContent = '—';
      }
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
    refreshHomeProgress();
    view('home');
  </script>
</body>

</html>